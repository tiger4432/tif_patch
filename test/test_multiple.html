<!DOCTYPE html>
<html>
<head>
    <title>Multi-File Streaming Test</title>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
</head>
<body>
    <h1>Real Image Data Streaming Test</h1>
    <button onclick="testSmallFile()">Test 82MB File (realistic_wafer_sample_fast.tif)</button>
    <button onclick="testMediumFile()">Test 500MB+ File (large_wafer_500chip...)</button>
    <button onclick="testLargeFile()">Test 2.4GB File (test.tif)</button>
    <button onclick="clearLogs()">Clear Logs</button>
    <div style="margin: 10px 0; padding: 10px; background: #f0f0f0;">
      <strong>üî• New: Real Image Data Processing!</strong><br>
      - Actual TIFF data streaming (not fake graphics)<br>
      - Chunk-by-chunk processing with compression<br>
      - Progressive memory management<br>
      - Original buffer deletion after processing
    </div>
    <div id="results"></div>

    <script type="module">
        import { ImageProcessor } from './js/imageProcessor.js';
        
        function log(message) {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            results.innerHTML += `<div>[${time}] ${message}</div>`;
            console.log(`[${time}] ${message}`);
        }
        
        function logMemory() {
            if (performance.memory) {
                const used = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                const total = (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(1);
                const limit = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(1);
                log(`Memory: ${used}/${total}MB (limit: ${limit}MB)`);
            }
        }
        
        window.testSmallFile = async function() {
            log('üîÑ Testing 82MB file...');
            logMemory();
            
            try {
                const start = Date.now();
                const pages = await ImageProcessor.loadTiffFromServer('./realistic_wafer_sample_fast.tif');
                const duration = ((Date.now() - start) / 1000).toFixed(1);
                
                log(`‚úÖ Small file success! ${pages.length} pages in ${duration}s`);
                logMemory();
                
            } catch (error) {
                log(`‚ùå Small file error: ${error.message}`);
                console.error('Small file test error:', error);
            }
        };
        
        window.testMediumFile = async function() {
            log('üîÑ Testing 500MB+ file (new 500x500 chips)...');
            logMemory();
            
            try {
                const start = Date.now();
                const pages = await ImageProcessor.loadTiffFromServer('./large_wafer_500chip_14900x14900_11layers.tif');
                const duration = ((Date.now() - start) / 1000).toFixed(1);
                
                log(`‚úÖ Medium file (500 chips) success! ${pages.length} pages in ${duration}s`);
                log(`üìä This used REAL image data streaming with compression!`);
                logMemory();
                
            } catch (error) {
                log(`‚ùå Medium file error: ${error.message}`);
                console.error('Medium file test error:', error);
                logMemory();
            }
        };

        window.testLargeFile = async function() {
            log('üî• Testing 2.4GB file with EXTREME streaming...');
            logMemory();
            
            try {
                const start = Date.now();
                const pages = await ImageProcessor.loadTiffFromServer('./test.tif');
                const duration = ((Date.now() - start) / 1000).toFixed(1);
                
                log(`üéâ Large file EXTREME success! ${pages.length} pages in ${duration}s`);
                log(`üöÄ This processed REAL 2.4GB image data with micro-chunks!`);
                logMemory();
                
            } catch (error) {
                log(`‚ùå Large file error: ${error.message}`);
                console.error('Large file test error:', error);
                logMemory();
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        // Initial memory log
        log('üöÄ Test page loaded');
        logMemory();
    </script>
</body>
</html>